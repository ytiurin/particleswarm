<!DOCTYPE><html><head><title>Particle swarm</title></head><body>

<div id="particle-container" style="position:fixed;left:0px;top:0px;width:100%;height:100%;background-image:url(./images/g7LogC3.png);background-size:contain;"></div>

<div style="color:white;padding:12px;font-size:20px;position:fixed;">
  <em>PARTICLE SWARM METHOD</em><br>
  <a href="https://en.wikipedia.org/wiki/Particle_swarm_optimization" target="_blank">Algorithm description</a><br>
  <button id="stop">Pause</button>
  <div id="fps"></div>
</div>

<script src="./swarm.js"></script>

<script>

var container = document.getElementById('particle-container');
var containerRect = container.getBoundingClientRect();

// CREATE SWARM
var swarm = new Swarm;

swarm.targetPosition = new Vector(
  containerRect.width / 2,
  containerRect.height / 2
);

swarm.particleBraking = 0.997;
swarm.maxSpeed = 50;

swarm.boundingRect = [
  new Vector,
  new Vector(
    containerRect.width,
    containerRect.height
  )
];

// CREATE PARTICLES
var elements=[];

var i = 100;

var l = 1;

var an = 0;

while(i--)
{
  var style=document.createAttribute('style');

  style.value = `
position:absolute;
left:0px;
top:0px;
width:80px;
height:80px;
background-image:url(./images/`+(l++)+`.png);
background-position: 50% 50%;
background-repeat: no-repeat;
`;

  l = l>12 ? 1 : l;

  var el = document.createElement("div");
  el.attributes.setNamedItem(style);

  el.addEventListener("animationend", function(){
    console.log('KK')
    if(++an===elements.length){
      an=0;
      nextFrame();
    }
  }, false);

  container.appendChild(el);

  elements.push(el);

  swarm.addParticle(
    new Particle(
      new Vector(
        Math.random()*containerRect.width,
        Math.random()*containerRect.height
      )
    )
  );
}

function drawNextFrame()
{
  requestAnimationFrame(function(){
    var particle, i=0;

    while(particle = swarm.particles[i++])
      elements[i-1].style.transform = "translate3d("+parseInt(particle.position.x-40)+"px,"+parseInt(particle.position.y-40)+"px,0)";

    drawNextFrame();
  });
}

drawNextFrame();

// CYCLE ANIMATION
var intervalId = setInterval(function(){
  if(mouseX&&mouseY)
    swarm.targetPosition = new Vector(mouseX, mouseY)

  swarm.next();
}, 16);

document.getElementById('stop').addEventListener('click',function(){
  clearInterval(intervalId);
});

// MANAGE MOUSE MOVEMENTS AND CLICKS
var mouseX=0,mouseY=0;

container.addEventListener('mousemove',function(e){
  e.preventDefault();
  mouseX = e.pageX;
  mouseY = e.pageY;
});

container.addEventListener('mousedown',function(e){
  e.preventDefault();
  swarm.particleBraking = 0.99;
});

container.addEventListener('mouseup',function(e){
  e.preventDefault();
  swarm.particleBraking = 0.997;
  swarm.explode(20);
});

container.addEventListener('touchmove',function(e){
  e.preventDefault();
  mouseX = e.touches[0].clientX;
  mouseY = e.touches[0].clientY;
});

container.addEventListener('touchstart',function(e){
  e.preventDefault();
  mouseX = e.touches[0].clientX;
  mouseY = e.touches[0].clientY;
  swarm.particleBraking = 0.99;
});

container.addEventListener('touchend',function(e){
  e.preventDefault();
  swarm.particleBraking = 0.997;
  swarm.explode(20);
});

// COUNT FPS
var fps = 0;
var fpsEl = document.getElementById('fps');

setInterval(function(){
  fpsEl.innerHTML = fps+"FPS";

  fps = 0;
}, 1000);

function catchNextFrame()
{
  requestAnimationFrame(function(){
    fps++;

    catchNextFrame();
  });
}

catchNextFrame();

</script>


</body></html>
